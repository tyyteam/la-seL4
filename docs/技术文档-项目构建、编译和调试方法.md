<!--
   SPDX-License-Identifier: GPL-2.0-only
   Copyright 2022, tyyteam(Qingtao Liu, Yang Lei, Yang Chen)
   qtliu@mail.ustc.edu.cn, le24@mail.ustc.edu.cn, chenyangcs@mail.ustc.edu.cn
-->
# é¡¹ç›®ä»“åº“æ‹‰å–

1. åˆ›å»º`sel4test`ç›®å½•ï¼Œç”¨repoå‘½ä»¤è·å–å®˜æ–¹ä»“åº“ï¼š

   ```
   mkdir sel4test && cd sel4test #the directory mentioned below
   repo init -u https://github.com/seL4/sel4test-manifest.git
   repo sync
   ```

2. åœ¨å¦ä¸€ä¸ªç›®å½•ï¼Œæ‹‰å–æˆ‘ä»¬çš„è„šæœ¬ä»“åº“ã€‚æŠŠè„šæœ¬è½¯é“¾æ¥åˆ°sel4testä»“åº“ä¸‹ï¼š

   ```
   git clone -b liuqingtao git@github.com:tyyteam/seL4-oscompProblemSolutions.git
   ln -s ${directory_of_seL4-oscompProblemSolutions}/scripts/sel4test/* ${directory_of_sel4test}/
   ```

3. åœ¨```sel4test```ç›®å½•ä¸‹ï¼Œå°†åŸæœ‰ä»“åº“æ›¿æ¢ä¸ºé¾™èŠ¯ä»“åº“ï¼š

   ```
   ./init_loongarch-seL4-test_dev.sh ssh
   # you can pull all the github repos of loongarch version using ./pull_loongarch_seL4-test_dev.sh ssh
   ```

# é¡¹ç›®ç¼–è¯‘

## æ–¹æ³•1ï¼šä½¿ç”¨dockerç¼–è¯‘
1. æ‹‰å–`la-seL4-CAmkES-L4v-dockerfilesr`ä»“åº“ï¼š

   ```
   git clone https://github.com/tyyteam/la-seL4-CAmkES-L4v-dockerfiles.git
   ```

2. åŠ å…¥bash aliasï¼Œéœ€è¦æ›¿æ¢`${directory_of_la-seL4-CAmkES-L4v-dockerfiles}`ç›®å½•ä¸ºç»å¯¹ç›®å½•ã€‚

   ```
   echo $'alias la-container=\'make -C ${directory_of_la-seL4-CAmkES-L4v-dockerfiles}/la-seL4-CAmkES-L4v-dockerfiles user_sel4-loongarch HOST_DIR=$(pwd)\'' >> ~/.bashrc
   source ~/.bashrc
   ```

4. åœ¨`sel4test`ç›®å½•ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ã€‚å°†å½“å‰ç›®å½•æ˜ å°„åˆ°containerã€‚

   ```
   la-container
   ```

5. åœ¨è¿è¡Œçš„dockeré•œåƒé‡Œï¼Œç¼–è¯‘é•œåƒã€‚

   ```
   mkdir build_3A5000 && cd build_3A5000
   ../init-build.sh -DPLATFORM=3A5000 -DLoongarch64=1 -DSIMULATION=1 && ninja
   
   # For riscv(spike):
   # mkdir build_spike && cd build_spike
   # ../init-build.sh -DPLATFORM=spike -DRISCV64=1 -DSIMULATION=1 && ninja
   
   # For arm(raspi3b):
   # mkdir build_rpi && cd build_rpi
   # ../init-build.sh -DPLATFORM=rpi3 -DBAMBOO=TRUE -DAARCH64=TRUE -DSIMULATION=1 && ninja
   
   # Note: You can also copy the 'cmake_ninja.sh' script to directory of sel4test. The soft link of the script mentioned above could not be executed.
   ```

## æ–¹æ³•2ï¼šæœ¬åœ°ç¼–è¯‘
1. æœ¬åœ°å®‰è£…seL4å®˜æ–¹æ¨èçš„ä¾èµ–åŒ…ï¼š[Dependencies(seL4 docs)](https://docs.sel4.systems/projects/buildsystem/host-dependencies.html)ï¼Œå®‰è£…é¾™èŠ¯äº¤å‰ç¼–è¯‘å·¥å…·ï¼š[å¼ è€å¸ˆæä¾›çš„èµ„æ–™](https://github.com/foxsen/qemu-loongarch-runenv)ã€‚

2. åœ¨```sel4test```ç›®å½•ä¸‹ï¼Œåˆ›å»ºbuild_3A5000æ–‡ä»¶å¤¹ï¼Œç¼–è¯‘é¾™èŠ¯ç‰ˆæœ¬çš„å¯æ‰§è¡Œé•œåƒã€‚

   ```
   mkdir build_3A5000 # you can create build_spike for seL4-riscv or build_rpi for seL4_rpi
   ./cmake_ninja.sh -l # the elf iamge is /build_3A5000/images/sel4test-driver-image-loongarch-3A5000
   
   # For riscv:
   # mkdir build_spike && ./cmake_ninja.sh -r
   
   # For arm(raspi3b):
   # mkdir build_rpi && ./cmake_ninja.sh -a
   ```

# é¡¹ç›®è¿è¡Œ

1. å…‹éš†qemu-loongarch-runenvã€‚

   ```
   # chose one git repo below. foxsen`s one is the original one. We made some change to the scripts and linux images.
   # 1. foxsen`s git repo:
   # git clone git@github.com:foxsen/qemu-loongarch-runenv.git
   # 2. Gootal`s git repo:
   # git clone git@github.com:GooTal/qemu-loongarch-runenv.git
   ```

2. å°†ç¼–è¯‘å‡ºçš„é•œåƒè½¯é“¾æ¥åˆ°qemu-loongarch-runenvç›®å½•ä¸‹ã€‚éœ€è¦æ›¿æ¢`${directory_of_sel4test}`å’Œ`${directory_of_qemu-loongarch-runenv}`ä¸ºç»å¯¹ç›®å½•ã€‚

   ```
   ln -s ${directory_of_sel4test}/build_3A5000/images/sel4test-driver-image-loongarch-3A5000 ${directory_of_qemu-loongarch-runenv}/
   ```

3. åœ¨`sel4test`ç›®å½•ä¸‹ï¼Œè¿è¡Œï¼š

   ```shell
   ./run_debug.sh -l
   ```

4. è¿è¡Œæ•ˆæœè§[è§†é¢‘](https://www.bilibili.com/video/BV1Mt4y1j7Gx?vd_source=c0ebc331ee63978f26b2050109cc5826)ã€‚ğŸ˜ŠğŸ˜Š




# é¡¹ç›®è°ƒè¯•æ–¹æ³•

## ç¯å¢ƒæ­å»º

æŒ‰ç…§å¼ è€å¸ˆçš„[è¿è¡Œç¯å¢ƒæ–‡æ¡£](https://github.com/foxsen/qemu-loongarch-runenv)ï¼Œå®‰è£…å¿…è¦çš„å·¥å…·ï¼šqemu-6.2.0ï¼ˆqemu-7.0.0 è°ƒè¯•riscvå­˜åœ¨[é—®é¢˜](https://github.com/seL4/seL4/issues/879)ï¼‰ï¼Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾ç­‰ã€‚

ä¸Šè¿°å·¥å…·å’Œè¿è¡Œç¤ºä¾‹éƒ½åœ¨**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

## è°ƒè¯•elfloaderæ–¹æ³•

1. å°†**sel4test-driver-image-loongarch-3A5000**å¤åˆ¶åˆ°**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

2. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**ï¼š

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

3. åœ¨build_3A5000/elfloaderç›®å½•ä¸‹ï¼Œæ–°å»ºç»ˆç«¯ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•elfloaderï¼š

   ```shell
   loongarch64-unknown-linux-gnu-gdb elfloader
   target remote:1234
   b main
   ```

4. åœ¨tools/seL4/elfloader-tool/src/arch-loongarch/boot.cçš„main()å‡½æ•°æ’æ¡©ï¼Œè¿è¡Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![20220529154137](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529154137.png)

![20220529154212](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529154212.png)



## è°ƒè¯•å¾®å†…æ ¸æ–¹æ³•

1. å°†**sel4test-driver-image-loongarch-3A5000**å¤åˆ¶åˆ°**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

2. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**ï¼š

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

2. åœ¨build_3A5000/kernelç›®å½•ä¸‹ï¼Œæ–°å»ºç»ˆç«¯ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•kernel.elf

   ```shell
   loongarch64-unknown-linux-gnu-gdb kernel.elf
   target remote:1234
   b init_kernel
   ```
   
3. åœ¨kernel/src/arch/loongarch/kernel/boot.cçš„init_kernel()å‡½æ•°æ’æ¡©ï¼Œè¿è¡Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚


![20220529161637](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529161637.png)

![20220529161312](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529161312.png)



# è°ƒè¯•qemu-system-loongarch64æ–¹æ³•

æ­¤èŠ‚å†…å®¹å¸®åŠ©ä½ è°ƒè¯•qemuæ¨¡æ‹Ÿçš„é¾™èŠ¯æœºå™¨ï¼Œæ–¹ä¾¿æŸ¥çœ‹æœºå™¨è¿è¡Œæƒ…å†µï¼ŒåŠ æ·±ä»£ç ç†è§£ã€‚

æ ¹æ®å¼ è€å¸ˆæä¾›çš„[qemuç¼–è¯‘æ–¹æ³•](https://github.com/foxsen/qemu-loongarch-runenv#qemu)ï¼Œè¿›å…¥[æ­¤å¤„](https://github.com/foxsen/qemu/tree/loongarch)æ‹‰å–loongarchåˆ†æ”¯ï¼Œç¼–è¯‘å‡ºdebugç‰ˆæœ¬çš„qemu-system-loongarch64å¯æ‰§è¡Œç¨‹åºã€‚

éœ€è¦å¼€å¯3ä¸ªç»ˆç«¯ã€‚

* ç»ˆç«¯1ï¼šè¿è¡Œ**sel4test-driver-image-loongarch-3A5000**

1. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

![20220529201103](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201103.png)

* ç»ˆç«¯2ï¼šè°ƒè¯•build_3A5000/kernelç›®å½•ä¸‹çš„kernel.elf

1. åœ¨build_3A5000/kernelç›®å½•ä¸‹ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•kernel.elf

   ```shell
   loongarch64-unknown-linux-gnu-gdb kernel.elf
   target remote:1234
   b try_init_kernel
   ```

![20220529201211](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201211.png)


* ç»ˆç«¯3ï¼šè°ƒè¯•qemu-system-loongarch64

1. æŸ¥çœ‹qemu-system-loongarch64çš„è¿›ç¨‹å·

   ```shel
   ps -ef|grep qemu-system-loongarch64
   ```

2. åœ¨**qemu-loongarch-runenv**ç›®å½•ä¸‹ï¼Œç”¨gdbè°ƒè¯•qemu-system-loongarch64

   ```shell
   sudo gdb qemu-system-loongarch64
   attach <è¿›ç¨‹å·>
   b loongarch_map_address_debug
   c
   ```

![20220529201304](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201304.png)

3. åœ¨ç»ˆç«¯2ä¸­è¾“å…¥cç»§ç»­è°ƒè¯•ï¼Œç¨‹åºå°†è¿è¡Œè‡³qemu-system-loongarch64çš„loongarch_map_address_debugæ–­ç‚¹å¤„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![20220529201000](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201000.png)









