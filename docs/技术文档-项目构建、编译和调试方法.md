<!--
   SPDX-License-Identifier: GPL-2.0-only
   Copyright 2022, tyyteam(Qingtao Liu, Yang Lei, Yang Chen)
   qtliu@mail.ustc.edu.cn, le24@mail.ustc.edu.cn, chenyangcs@mail.ustc.edu.cn
-->
# é¡¹ç›®æ„å»ºå’Œç¼–è¯‘
## æ–¹æ³•1ï¼šä½¿ç”¨docker
1. æ‹‰å»ä»£ç ä»“åº“
```
git clone https://github.com/tyyteam/la-seL4-CAmkES-L4v-dockerfiles.git
```
2. åŠ å…¥bash aliasï¼Œä¹‹åå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤`la-container`è¿è¡Œï¼Œä¼šæ˜ å°„å½“å‰ç›®å½•åˆ°container
```
echo $'alias la-container=\'make -C /<path>/<to>/la-seL4-CAmkES-L4v-dockerfiles user_sel4-loongarch HOST_DIR=$(pwd)\'' >> ~/.bashrc
source ~/.bashrc
```
è¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨dockerä¸­è¿›è¡Œé¡¹ç›®çš„ç¼–è¯‘ï¼Œéš”ç¦»seL4ç›¸å…³çš„ä¾èµ–ã€‚
è¿è¡Œgdbè°ƒè¯•é¡¹ç›®å»ºè®®åœ¨æœ¬æœºä¸­è¿›è¡Œï¼Œéœ€è¦å®‰è£…[é¾™èŠ¯qemu](https://github.com/foxsen/qemu-loongarch-runenv#qemu)å’Œ[é¾™èŠ¯gdb](https://github.com/foxsen/qemu-loongarch-runenv#gdb)ã€‚
## æ–¹æ³•2ï¼šåœ¨æœ¬æœºä¸Šå®‰è£…æ‰€éœ€ä¾èµ–
1. å®‰è£…seL4å®˜æ–¹ç»™å‡ºçš„ä¾èµ–åŒ…ï¼š[Dependencies(seL4 docs)](https://docs.sel4.systems/projects/buildsystem/host-dependencies.html)ï¼Œå®‰è£…é¾™èŠ¯äº¤å‰ç¼–è¯‘å·¥å…·ï¼š[å¼ è€å¸ˆæä¾›çš„èµ„æ–™](https://github.com/foxsen/qemu-loongarch-runenv)ã€‚

2. å…‹éš†qemu-loongarch-runenvã€‚

   ```
   # chose one git repo below. foxsen`s one is the original one. We made some change to the scripts and linux images.
   # 1. foxsen`s git repo:
   # git clone git@github.com:foxsen/qemu-loongarch-runenv.git
   # 2. Gootal`s git repo:
   # git clone git@github.com:GooTal/qemu-loongarch-runenv.git
   ```
   
2. åˆ›å»ºå¹¶è¿›å…¥`sel4test`ç›®å½•ï¼Œç”¨repoå‘½ä»¤è·å–å®˜æ–¹åº“ï¼š

   ```shell
   mkdir sel4test && cd sel4test #the directory mentioned below
   repo init -u https://github.com/seL4/sel4test-manifest.git
   repo sync
   ```
   
3. åœ¨å¦ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ‹‰å–æˆ‘ä»¬çš„è„šæœ¬ä»“åº“ï¼Œåˆ›å»ºè½¯é“¾æ¥åˆ°sel4testä»“åº“ä¸‹ï¼š

   ```
   git clone -b liuqingtao git@github.com:tyyteam/seL4-oscompProblemSolutions.git
   ln -s ${directory_of_seL4-oscompProblemSolutions}/scripts/sel4test/* ${directory_of_sel4test}/
   ```

3. åœ¨```sel4test```ç›®å½•ä¸‹ï¼Œå°†åŸæœ‰ä»“åº“æ›¿æ¢ä¸ºé¾™èŠ¯ä»“åº“ï¼š

   ```shell
   ./init_loongarch-seL4-test_dev.sh ssh
   # you can pull all the github repos of loongarch version using ./pull_loongarch_seL4-test_dev.sh ssh
   ```
   
6. åœ¨```sel4test```ç›®å½•ä¸‹ï¼Œåˆ›å»ºbuild_3A5000æ–‡ä»¶å¤¹ï¼Œç¼–è¯‘é¾™èŠ¯ç‰ˆæœ¬çš„å¯æ‰§è¡Œé•œåƒã€‚å°†é•œåƒè½¯é“¾æ¥åˆ°qemu-loongarch-runenvä¸‹ã€‚

   ```shell
   mkdir build_3A5000
   ./cmake_ninja.sh -l
   ln -s ${directory_of_sel4test}/build_3A5000/images/sel4test-driver-image-loongarch-3A5000 ${directory_of_qemu-loongarch-runenv}/
   ```

5. è¿è¡Œï¼š

   ```shell
   ./run_debug.sh -l
   ```
   
6. åœ¨build_3A5000/imagesæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆelfæ ¼å¼æ–‡ä»¶ï¼š**sel4test-driver-image-loongarch-3A5000**ã€‚

   

ğŸ˜Šä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘å’Œè¿è¡Œriscvã€armæ¶æ„çš„seL4å¾®å†…æ ¸

```
#For riscv:
mkdir build_spike
./cmake_ninja.sh -r
./run_debug.sh -r
#For arm
mkdir build_rpi
./cmake_ninja.sh -a
./run_debug.sh -a
```



# é¡¹ç›®è°ƒè¯•æ–¹æ³•

## ç¯å¢ƒæ­å»º

æŒ‰ç…§å¼ è€å¸ˆçš„[è¿è¡Œç¯å¢ƒæ–‡æ¡£](https://github.com/foxsen/qemu-loongarch-runenv)ï¼Œå®‰è£…å¿…è¦çš„å·¥å…·ï¼šqemu-6.2.0(qemu-7.0.0 å­˜åœ¨[é—®é¢˜](https://github.com/seL4/seL4/issues/879))ï¼Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾ç­‰ã€‚

ä¸Šè¿°å·¥å…·å’Œè¿è¡Œç¤ºä¾‹éƒ½åœ¨**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

## è°ƒè¯•elfloaderæ–¹æ³•

1. å°†**sel4test-driver-image-loongarch-3A5000**å¤åˆ¶åˆ°**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

2. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**ï¼š

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

3. åœ¨build_3A5000/elfloaderç›®å½•ä¸‹ï¼Œæ–°å»ºç»ˆç«¯ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•elfloaderï¼š

   ```shell
   loongarch64-unknown-linux-gnu-gdb elfloader
   target remote:1234
   b main
   ```

4. åœ¨tools/seL4/elfloader-tool/src/arch-loongarch/boot.cçš„main()å‡½æ•°æ’æ¡©ï¼Œè¿è¡Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![20220529154137](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529154137.png)

![20220529154212](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529154212.png)



## è°ƒè¯•å¾®å†…æ ¸æ–¹æ³•

1. å°†**sel4test-driver-image-loongarch-3A5000**å¤åˆ¶åˆ°**qemu-loongarch-runenv**ç›®å½•ä¸‹ã€‚

2. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**ï¼š

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

2. åœ¨build_3A5000/kernelç›®å½•ä¸‹ï¼Œæ–°å»ºç»ˆç«¯ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•kernel.elf

   ```shell
   loongarch64-unknown-linux-gnu-gdb kernel.elf
   target remote:1234
   b init_kernel
   ```
   
3. åœ¨kernel/src/arch/loongarch/kernel/boot.cçš„init_kernel()å‡½æ•°æ’æ¡©ï¼Œè¿è¡Œæƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚


![20220529161637](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529161637.png)

![20220529161312](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529161312.png)



# è°ƒè¯•qemu-system-loongarch64æ–¹æ³•

æ­¤èŠ‚å†…å®¹å¸®åŠ©ä½ è°ƒè¯•qemuæ¨¡æ‹Ÿçš„é¾™èŠ¯æœºå™¨ï¼Œæ–¹ä¾¿æŸ¥çœ‹æœºå™¨è¿è¡Œæƒ…å†µï¼ŒåŠ æ·±ä»£ç ç†è§£ã€‚

æ ¹æ®å¼ è€å¸ˆæä¾›çš„[qemuç¼–è¯‘æ–¹æ³•](https://github.com/foxsen/qemu-loongarch-runenv#qemu)ï¼Œè¿›å…¥[æ­¤å¤„](https://github.com/foxsen/qemu/tree/loongarch)æ‹‰å–loongarchåˆ†æ”¯ï¼Œç¼–è¯‘å‡ºdebugç‰ˆæœ¬çš„qemu-system-loongarch64å¯æ‰§è¡Œç¨‹åºã€‚

éœ€è¦å¼€å¯3ä¸ªç»ˆç«¯ã€‚

* ç»ˆç«¯1ï¼šè¿è¡Œ**sel4test-driver-image-loongarch-3A5000**

1. qemu debugæ’æ¡©æ¨¡å¼è¿è¡Œ**sel4test-driver-image-loongarch-3A5000**

   ```shell
   ./run_loongarch.sh -k sel4test-driver-image-loongarch-3A5000 -D
   ```

![20220529201103](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201103.png)

* ç»ˆç«¯2ï¼šè°ƒè¯•build_3A5000/kernelç›®å½•ä¸‹çš„kernel.elf

1. åœ¨build_3A5000/kernelç›®å½•ä¸‹ï¼Œç”¨é¾™èŠ¯gdbè°ƒè¯•kernel.elf

   ```shell
   loongarch64-unknown-linux-gnu-gdb kernel.elf
   target remote:1234
   b try_init_kernel
   ```

![20220529201211](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201211.png)


* ç»ˆç«¯3ï¼šè°ƒè¯•qemu-system-loongarch64

1. æŸ¥çœ‹qemu-system-loongarch64çš„è¿›ç¨‹å·

   ```shel
   ps -ef|grep qemu-system-loongarch64
   ```

2. åœ¨**qemu-loongarch-runenv**ç›®å½•ä¸‹ï¼Œç”¨gdbè°ƒè¯•qemu-system-loongarch64

   ```shell
   sudo gdb qemu-system-loongarch64
   attach <è¿›ç¨‹å·>
   b loongarch_map_address_debug
   c
   ```

![20220529201304](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201304.png)

3. åœ¨ç»ˆç«¯2ä¸­è¾“å…¥cç»§ç»­è°ƒè¯•ï¼Œç¨‹åºå°†è¿è¡Œè‡³qemu-system-loongarch64çš„loongarch_map_address_debugæ–­ç‚¹å¤„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![20220529201000](https://raw.githubusercontent.com/GooTal/picBed/master/myPics/20220529201000.png)









